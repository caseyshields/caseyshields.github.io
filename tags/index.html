<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tag Widget</title>
<link href="../site.css" rel="stylesheet"/>
</head>
<body>
    <div class="overlay">
        <h1> Tag Widget </h1>
        <h4> In preparation of more content, I want to have a more efficient tag query utility for sorting more entries.</h4>
    </div>
    <section>
        <svg width="1024" height="768" style="background-color:#888"></svg>
    </section>
    <script src="https://d3js.org/d3.v4.js"></script>
<script>

// Prepare selectors
let svg = d3.select('svg');
let width = +svg.attr('width');
let height = svg.attr('height');
let nodes = svg.selectAll('.node');
let edges = svg.selectAll('.edge');

// sample dataset
let articles = [
    { title:"Dragon", tags:["origami","diagrams"] },
    { title:"MCV03", tags:["lego", "stud.io"]},
    { title:"Elephant", tags:["origami", "cp"]},
    { title:"BeamTrooper", tags:["lego", "mfz"]},
    { title:"Starmap", tags:["D3", "FK6", "astronomy"] },
    { title:"Fractal", tags:["Js", ] },
    { title:"Orion", tags:["astronomy", "novas", "C"] }
];
//TODO load dataset from a precompiled json!

// find all unique tags, and make D3 nodes for each
let map = {};
for( article of articles )
    for( tag of article.tags )
        if( map[tag] == null )
            map[tag] = {text:tag, weight:1};
        else map[tag].weight++;
let tags = [];
for( tag in map )
    tags.push( map[tag] );

// compile all links; tag pairs which were associated with the same article
// let links = [];
// for( tag in tags ) {
//     for( article in articles ) {

//     }
// }

// Prepare simulation
// let linking = d3.forceLink()
//     .links( links )
//     .distance( .75 );
let charging = d3.forceManyBody();
let centering = d3.forceCenter()
    .x( width/2 )
    .y( height/2 );
let simulation = d3.forceSimulation( tags )
    // .force( 'linking', linking )
    .force( 'charging', charging )
    .force( 'centering', centering )
    .alphaTarget( 1 )
    .on( 'tick', tock );

// callback for simulation's main loop
function tock() {

    // TODO I don't think we have to update this every frame...
    nodes = nodes.data( tags );
    let entered = nodes.enter()
        .append( 'g' )
        .attr( 'class', 'node' );

    entered.append( 'circle' )
        .attr('class', 'node' )
        .attr('r', function(d) {return 20*d.weight;} );

    entered.append( 'text' )
        .text( function(d) {return d.text;} );

    nodes = entered.merge( nodes )
        .attr("transform", function(d) {return "translate("+d.x+", "+d.y+")";})
        .call( d3.drag()
            .on('start', started)
            .on('drag', dragged)
            .on('end', ended)
        );
}

function started(d) {
    d.fx = d.x;
    d.fy = d.y;
}
function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
}
function ended(d) {
    d.fx = null;
    d.fy = null;
}

</script>

<style>
    .overlay {
        position: absolute;
        top: 10%;
        left: 10%;
    }
    svg {
        position: absolute;
        left: 0;
        top: 0;
        z-index: -1;
    }
    .node > circle {
        fill: lightgray;
        stroke: black;
    }
    .node > text {
        fill: black;
        stroke: black;
        text-align: center;
    }
    .link {
        stroke: black;
        stroke-width: 2px;
        fill: none;
    }
    </style>
</body>
</html>